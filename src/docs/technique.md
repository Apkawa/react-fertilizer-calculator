# Алгоритм расчетов

NPK удобрений указывается в процентном отношении оксидов `N`, `P2O5` и `K2O`

Дано:

1. Комплексное удобрение `3:11:38`
2. Рецепт `N=200 P=50 K=200 Ca=170 Mg=50`

## Оксид-фактор
Сначала считается содержание чистых элементов, умножая процент оксида на его `оксид-фактор`

`Оксид-фактор` - характеризует содержание целевого химического элемента в соединении. Выражается в граммах элемента содержащемся в 1 грамме соединения.

Пример расчета для фосфора. (P2O5)

|Элемент | Атомная масса | Количество | Итого |
|--------|---------------|------------|-------|
| P | 30,97 | 2 | 61.94 |
| O | 15,99 | 5 | 79.95 |
| P2O5 |  |  | 141.89 |

```
P = 61.94 / 141.89 = 0.436 ~= 0.44
```
И обратно:
```
P2O5 =  141.89 / 61.94 = 2.29
```

Аналогично и с другими оксидами.

Для упрощения расчетов можно воспользоваться готовой таблицей коэфициентов оксидов:

|      | элемент   |   оксид |
|------|-----------|---------|
| N    | 1         | 1       |
| P2O5 | 0,44      | 2,29    |
| K2O  | 0,83      | 1,2     |
| CaO  | 0,71      | 1,4     |
| MgO  | 0,6       | 1,66    |

## Состав удобрения

Состав удобрения как правило указываются в процентном содержании оксидов.

Существуют различные варианты записи

Краткая запись вида эквивалетно `N=3 P2O5=11 K2O=38`
   - `3:11:38` - не путать с пропорциями
   - `3-11-38`

И полная запись с указанием процентовок, с этим все понятно.

Исключение составляет азот, хоть и бывает что его пишут в форме оксидов, 
понимать его надо как содержание чистого элемента:

   - `N`
   - `азот общий`
   - `NO3`

### NPK состав удобрения в % чистых

Пересчитанный NPK в % чистых элементов
```
3:11:38 => 3*1:11*0.44:38*0.83 => 3:4.84:31.54 или N=3 P=4.84 K=31.54
```

## Расчет навески

Рецепт для раствора указывается в `мг/литр` чистых элементов, без оксидов. Еще называют как `ppm`

Расчет в калькуляторе ведется перебором от 0 до 15г для каждого из выбранного удобрения.

Допустим, самое оптимальное количество удобрения - 1.5г

```
N = (3% / 100) * 1.5г * 1л = 0.045г/л * 1000 = 45мг/л 
```
Или, упрощенно:
```
N = 3 * 1.5 * 10 = 45.0 мг/л
P = 4.84 * 1.5 * 10 = 72 мг/л
K = 31.54 * 1.5 * 10 = 473.1 мг/л
```

Итого: 1.5г удобрения дадут `N=45 P=72 K=473` потребности в элементах, с превышением калия.

Для того чтобы навеска попала в профиль используются несколько удобрений и калькулятором ищем наиболее оптимальную комбинацию навесок удобрения.


## Расчет NPK удобрения по формуле

Удобрения в калькуляторе хранятся в виде химической формулы и его процентного содержания:

Дано: удобрение `Нитрат калия`, химическая формула `KNО3`, чистота - 100%.

|Элемент | Атомная масса | Количество | Итого |
|--------|---------------|------------|-------|
| N | 14 | 1 | 14 |
| O | 15,99 | 3 | 47.97 |
| K | 39,09 | 1 | 39,09 |
| KNO3 |  |  | 101,06 |

Итого NPK чистых элементов: 
```
N = (14 / 101.06) * 100% = 13.85 
K = (39.09 / 101.06) * 100% = 38.68
```

Пересчитаем в NPK оксидов:
``` 
N = 13.85*1 ~= 14
P = 0
K = 38.68*1.2 = 46.4
```

Итого: NPK - 14:0:46.4


Алгоритм работает и со смесями, 
вместо 100% используется процентное содержание вещества в смеси, 
NPK элементов  считается для каждого компонента по отдельности и затем суммируется. 
Потом уже переводится в NPK оксидов по коэфициентам из таблицы.

# TDS и ЕС

`TDS (Total Dissolved Solids)` - это суммарный количественный показатель концентрации 
растворенных в воде веществ (солей) или - общее солесодержание. 
Указывается в `ppm`.
Для растворов 1ppm принимается за 1мг/л.

`Электропроводность` - это численное выражение способности водного раствора проводить электрический ток. 
Электрическая проводимость природной воды зависит в основном от степени минерализации и температуры. 
Указывается в `мСм/см`.

TDS - считается как сумма растворенных солей на 1л воды. 
ЕС - в зависимости от коэфициента преобразования - либо равно TDS, либо:

```
EC = (TDS * (1/k)) / 1000
TDS = (EC * k) * 1000
```
Где `k` - коэфициент преобразования прибора. и может быть равен 0.5, 0.7 и 1.0

В калькуляторе считается примерный TDS, в реальности может отличаться и зависеть от качества исходной воды и удобрений.

## Долив раствора

Допустим у нас есть старый раствор объемом 20 л. с EC=0.6 мСм/см
Нужно получить 25 л. раствора с EC=2.0 мСм/см

1. Считаем количество раствора который нужно долить
   ```
   Vd = Vnew - Vcur
   Vd = 25 - 20
   ```
1. Считаем EC раствора который нужно долить \
   ```
   ECn = -(EC*Vcur - ECplan*Vcur - ECplan*Vd )/Vd)
   ECn = -(0.6 * 20 - 2.0 * 20 - 2.0 * 5)/5 = 7.6 мСм/см
   ```
2. Считаем отношение веса солей старого профиля в 1л к ECold (старого профиля, не текущего)
   ```
   W2Ec = WeightPerLiter / ECold
   W2Ec = 0.684 / 0.75 = 0.91
   ```
3. Считаем количество солей которые нужно внести
   ```
   Weight = ECnew * W2Ec * Vd
   Weight = 7.6 * 0.91 * 5 = 34.58г
   ```

4. Считаем требуемую концентрацию раствора для долива
   ```
   C = (Weight  / 2 ) / Vd
   C = (34.58 / 2) / 5 = 3.45
   ```

Итого - нам нужно приготовить 5 литров раствора c выбранным EC=2.0 и концентрацией 1:3.45


## Разбавление 

Основой для расчетов служит [**формула разбавления**](https://en.wikipedia.org/wiki/Dilution_(equation)):

```
C₁ × V₁ = C₂ × V₂
```

где:
- **C₁** — концентрация исходного раствора (коэффициент разбавления концентрата),
- **V₁** — объем концентрата,
- **C₂** — концентрация готового раствора (по умолчанию равна 1),
- **V₂** — итоговый объем раствора после разбавления.

Если **C₂ = 1**, формула упрощается:  

* Для расчета степени концентрации из `V₁мл` на `V₂л` в `1:C₁`
   ```
   C₁ = V₂ / V₁.  
   ```

* Для необходимого объема концентрата
   ```
   V₁ = V₂ / C₁
   ``` 
  
Здесь:
- **C₁** показывает, во сколько раз концентрат сильнее готового раствора,
- **V₁** — объем концентрата, необходимый для приготовления **V₂** мл раствора.


#### Примеры расчетов:

1. Допустим, концентрат 35мл на 5л. Нужен раствор на 10л
   - **Определение коэффициента разбавления**:  
      Если для 5 л (5000 мл) раствора использовано 35 мл концентрата, то:  
      `C₁ = 5000 мл / 35 мл ≈ 142.86`.  
      Это означает, что концентрат в **142.86 раз** сильнее готового раствора. 
      
      Записывается так `1:142.86`

   - **Расчет объема концентрата для нового раствора**:  
      Чтобы приготовить 10 л (10000 мл) раствора с коэффициентом **C₁ = 142.86**:  
      `V₁ = 10000 мл / 142.86 ≈ 70 мл`.  
      Требуется **70 мл концентрата**.

2. Концентрат разводится в пропорции **1 мл на 1 л** готового раствора. Требуется приготовить **3 л** раствора.

   - Определим коэффициент разбавления (**C₁**) из исходных данных:
      - Для **1 л (1000 мл)** раствора используется **1 мл** концентрата.
      - `C₁ = V₂ / V₁ = 1000 мл / 1 мл = 1000`.
   - Рассчитаем объем концентрата для **3 л (3000 мл)** раствора:
      - `V₁ = V₂ / C₁ = 3000 мл / 1000 = 3 мл`.

   - **Итог**:  
   Для приготовления **3 л** раствора потребуется **3 мл концентрата**.

3. Концентрат имеет соотношение **1:1000**. Это означает:

   - **1 часть концентрата** разводится в **1000 частях раствора**.
   - Как перевести соотношение **1:1000** в **мл/л**:
      1. **1 часть = 1 мл**, **1000 частей = 1000 мл (1 л)**.
      2. Следовательно, **1 мл концентрата** требуется для приготовления **1 л раствора**.

   - **Проверка через формулу**:
      - Коэффициент разбавления:  
        `C₁ = V₂ / V₁ = 1000 мл / 1 мл = 1000`.
      - Соотношение **1:1000** соответствует коэффициенту **C₁ = 1000**.




# Источники

* [Модель расчетов](https://github.com/Apkawa/react-fertilizer-calculator/blob/master/docs/model_v3.ipynb)
* [Расчет разбавления](https://github.com/Apkawa/react-fertilizer-calculator/blob/master/docs/dillution.ipynb)
* https://github.com/WEGA-project/wega-hpg/wiki/Theory:-How-To